<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>11DG11 å ±åƒ¹ç³»çµ±</title>
    <link rel="icon" href="favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #ff69b4;
            --primary-dark: #e055a3;
            --secondary-color: #ffe4ec;
            --accent-color: #ffb6c1;
            --background-color: #fff0f5;
            --text-color: #4b2e2e;
            --card-radius: 16px;
            --shadow: 0 8px 20px rgba(255, 105, 180, 0.15);
        }
        
        body {
            font-family: 'Poppins', 'Segoe UI', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://cdn-icons-png.flaticon.com/512/833/833472.png');
            background-repeat: repeat;
            background-size: 30px;
            opacity: 0.05;
            animation: bgFloat 30s linear infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes bgFloat {
            from { background-position: 0 0; }
            to { background-position: 1000px 1000px; }
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.6rem;
            color: var(--primary-color);
            text-shadow: 1px 1px 3px rgba(255, 105, 180, 0.2);
        }
        
        .card {
            border-radius: var(--card-radius);
            background-color: #ffffff;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            transform-origin: top;
            animation: foldOpen 0.6s ease forwards, fadeInUp 0.5s ease forwards;
        }
        
        .card:hover {
            transform: scale(1.02);
            box-shadow: 0 12px 30px rgba(255, 105, 180, 0.3);
        }
        
        .card-header {
            background: linear-gradient(135deg, #ff69b4, #ffc0cb);
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
            border-radius: var(--card-radius) var(--card-radius) 0 0;
            padding: 16px;
            box-shadow: 0 4px 6px rgba(255, 105, 180, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ff69b4, #ffa6c9);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            padding: 10px 24px;
            color: white;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 105, 180, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 8px 24px rgba(255, 105, 180, 0.5);
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #ffc0cb;
            transition: border 0.3s ease, box-shadow 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(255, 105, 180, 0.25);
        }
        
        .preview-image {
            max-width: 240px;
            max-height: 240px;
            margin-top: 15px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: none;
            animation: fadeIn 0.6s ease forwards;
        }
        
        .result-container {
            display: none;
            margin-top: 30px;
            animation: fadeIn 0.6s ease forwards;
        }
        
        .result-card {
            background-color: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
            transition: transform 0.4s ease, box-shadow 0.4s ease;
            animation: foldOpen 0.5s ease;
        }
        
        .result-card:hover {
            transform: scale(1.01);
            box-shadow: 0 10px 24px rgba(255, 105, 180, 0.25);
        }
        
        .result-image {
            max-width: 100%;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.05);
        }
        
        .tab-content {
            padding: 20px;
            animation: slideIn 0.6s ease forwards;
        }
        
        .nav-tabs {
            border-bottom: none;
            justify-content: flex-end;
            margin-bottom: 10px;
        }
        
        .nav-tabs .nav-link {
            border: none;
            border-radius: 20px;
            margin-left: 10px;
            padding: 8px 20px;
            font-weight: 600;
            background: linear-gradient(135deg, #ffe0f0, #ffd1e5);
            color: var(--text-color);
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(255, 105, 180, 0.2);
        }
        
        .nav-tabs .nav-link:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 105, 180, 0.3);
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #ff69b4, #ffa6c9);
            color: white;
            box-shadow: 0 6px 18px rgba(255, 105, 180, 0.4);
        }
        
        .history-item {
            border-left: 5px solid var(--primary-color);
            padding: 16px;
            background-color: #fff;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            animation: fadeInUp 0.5s ease both;
        }
        
        .currency-link {
            color: var(--primary-color);
            font-weight: 500;
            text-decoration: none;
        }
        
        .currency-link:hover {
            text-decoration: underline;
        }
        
        #previewResult {
            max-width: 700px;
            margin: 0 auto;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }
        
        .clear-history {
            margin-top: 24px;
            text-align: right;
        }
        
        /* âœ¨ å°è¦½é€£çµæ¨£å¼ï¼ˆå³ä¸Šè§’ï¼‰ */
        .navbar-nav a {
            padding: 6px 16px;
            margin-left: 8px;
            border-radius: 20px;
            background: linear-gradient(135deg, #ffe0f0, #ffd1e5);
            font-weight: 600;
            color: var(--text-color);
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(255, 105, 180, 0.2);
            text-decoration: none;
        }
        
        .navbar-nav a:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(255, 105, 180, 0.3);
        }
        
        .navbar-nav a.active {
            background: linear-gradient(135deg, #ff69b4, #ffa6c9);
            color: white;
            box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes foldOpen {
            0% { transform: rotateX(-90deg); opacity: 0; }
            100% { transform: rotateX(0deg); opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateX(30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .return-home-btn {
    position: fixed;
    top: 15px;
    right: 20px;
    background: linear-gradient(to right, #ff85b3, #ffa6c1);
    color: white;
    padding: 8px 16px;
    border-radius: 30px;
    font-weight: bold;
    font-size: 14px;
    text-decoration: none;
    box-shadow: 0 4px 10px rgba(255, 105, 180, 0.3);
    transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    z-index: 9999;
}

.return-home-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 14px rgba(255, 105, 180, 0.4);
    background: linear-gradient(to right, #ff5e9c, #ff87b8);
}
        </style>
        
    
</head>
<body>  
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-calculator me-2"></i>11DG11 å ±åƒ¹ç³»çµ±
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" id="quotation-tab">å ±åƒ¹è¨ˆç®—</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="history-tab">æ­·å²è¨˜éŒ„</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="row">
            <div class="col-lg-8 mx-auto">
  <!-- åŒ¯ç‡æŸ¥è©¢é€£çµ -->
  <div class="card mb-4">
    <div class="card-header">
        åŒ¯ç‡æŸ¥è©¢
    </div>
    <div class="card-body">
      <a href="https://www.google.com/search?q=å°å¹£éŸ“å…ƒåŒ¯ç‡" target="_blank" class="btn btn-outline-primary currency-link">
        <i class="fas fa-exchange-alt me-1"></i> éŸ“å¹£åŒ¯ç‡æŸ¥è©¢
      </a>
      <a href="https://www.google.com/search?q=æ—¥å…ƒå°å¹£åŒ¯ç‡" target="_blank" class="btn btn-outline-primary currency-link ms-2">
        <i class="fas fa-exchange-alt me-1"></i> æ—¥å…ƒåŒ¯ç‡æŸ¥è©¢
      </a>
      <a href="https://www.google.com/search?q=äººæ°‘å¹£å°å¹£åŒ¯ç‡" target="_blank" class="btn btn-outline-primary currency-link ms-2">
        <i class="fas fa-exchange-alt me-1"></i> äººæ°‘å¹£åŒ¯ç‡æŸ¥è©¢
      </a>
      <a href="https://www.google.com/search?q=ç¾å…ƒå°å¹£åŒ¯ç‡" target="_blank" class="btn btn-outline-primary currency-link ms-2">
        <i class="fas fa-exchange-alt me-1"></i> ç¾å…ƒåŒ¯ç‡æŸ¥è©¢
      </a>
    </div>
</div>

                <!-- ä¸»è¡¨å–® -->
                <div class="card mb-4" id="quotation-section">
                    <div class="card-header">
                        å•†å“å ±åƒ¹è¨ˆç®—
                    </div>
                    <div class="card-body">
                        <form id="quotationForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="productImage" class="form-label">å•†å“åœ–ç‰‡</label>
                                    <input class="form-control" type="file" id="productImage" accept="image/*">
                                    <img id="imagePreview" class="preview-image mt-2" alt="åœ–ç‰‡é è¦½">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="productId" class="form-label">å•†å“ç·¨è™Ÿ</label>
                                    <input type="text" class="form-control" id="productId" required>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label for="productName" class="form-label">å•†å“åç¨±</label>
                                    <input type="text" class="form-control" id="productName" required>
                                    <input type="number" step="0.01" class="form-control" id="exchangeRate" required placeholder="è«‹è¼¸å…¥åŒ¯ç‡ (ä¾‹å¦‚ 4.38)">

                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="productCategory" class="form-label">å•†å“é¡åˆ¥</label>
                                    <select class="form-select" id="productCategory" required>
                                        <option value="">é¸æ“‡é¡åˆ¥</option>
                                        <option value="è¡£æœ">è¡£æœ</option>
                                        <option value="è¤²å­">è¤²å­</option>
                                        <option value="å¸½å­">å¸½å­</option>
                                        <option value="é‹å­">é‹å­</option>
                                        <option value="è¥ªå­">è¥ªå­</option>
                                        <option value="é£Ÿå“">é£Ÿå“</option>
                                        <option value="ç¾å¦">ç¾å¦</option>
                                        <option value="å¨ƒå¨ƒ">å¨ƒå¨ƒ</option>
                                        <option value="åŠé£¾">åŠé£¾</option>
                                        <option value="ä¿é¤Šå“">ä¿é¤Šå“</option>
                                        <option value="å…¶ä»–">å…¶ä»–</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="productCost" class="form-label">å•†å“æˆæœ¬</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="productCost" step="0.01" required>
                                        <select class="form-select" id="costCurrency" style="max-width: 120px;">
                                            <option value="KRW">éŸ“å…ƒ (KRW)</option>
                                            <option value="JPY">æ—¥å…ƒ (JPY)</option>
                                            <option value="USD">ç¾å…ƒ (USD)</option>
                                            <option value="CNY">äººæ°‘å¹£ (CNY)</option>
                                            <option value="TWD">æ–°å°å¹£ (TWD)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="productWeight" class="form-label">å•†å“é‡é‡</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="productWeight" step="0.01" required>
                                        <select class="form-select" id="weightUnit" style="max-width: 100px;">
                                            <option value="g">å…¬å…‹ (g)</option>
                                            <option value="kg">å…¬æ–¤ (kg)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="internationalShipping" class="form-label">åœ‹éš›é‹è²» (æ¯å–®ä½æ–°å°å¹£)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">NT$</span>
                                        <input type="number" class="form-control" id="internationalShipping" step="0.01" required>
                                        <span class="input-group-text" id="shippingUnitLabel">/g</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="serviceFeePercent" class="form-label">ä»£ä»˜ç™¾åˆ†æ¯”</label>
                                    <select class="form-select" id="serviceFeePercent" required>
                                        <option value="0.01">1%</option>
                                        <option value="0.02">2%</option>
                                        <option value="0.03">3%</option>
                                        <option value="0.04">4%</option>
                                        <option value="0.05">5%</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="additionalServiceFee" class="form-label">é¡å¤–æœå‹™è²» (æ–°å°å¹£)</label>
                                <div class="input-group">
                                    <span class="input-group-text">NT$</span>
                                    <input type="number" class="form-control" id="additionalServiceFee" step="0.01" value="0">
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-calculator me-2"></i>è¨ˆç®—å ±åƒ¹
                                </button>
                            </div>
                        </form>

                        <div class="result-container mt-4" id="resultContainer">
                            <div class="result-card">
                                <h5 class="text-center mb-3">å ±åƒ¹çµæœ</h5>
                                <div class="text-center mb-3">
                                    <img id="resultImagePreview" class="result-image" alt="å•†å“åœ–ç‰‡">
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>å•†å“ç·¨è™Ÿ:</strong> <span id="resultProductId"></span></p>
                                        <p><strong>å•†å“åç¨±:</strong> <span id="resultProductName"></span></p>
                                        <p><strong>å•†å“é¡åˆ¥:</strong> <span id="resultProductCategory"></span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>å•†å“æˆæœ¬:</strong> <span id="resultProductCost"></span></p>
                                        <p><strong>å•†å“é‡é‡:</strong> <span id="resultProductWeight"></span></p>
                                        <p><strong>åœ‹éš›é‹è²»:</strong> <span id="resultShippingFee"></span></p>
                                    </div>
                                </div>
                                <hr>
                                <div class="text-center">
                                    <h4 class="text-primary">ç¸½å ±åƒ¹: <span id="resultTotalPrice"></span></h4>
                                    <p class="text-muted"><small>è¨ˆç®—æ™‚é–“: <span id="calculationTime"></span></small></p>
                                </div>
                            </div>

                            <div class="d-flex justify-content-center gap-3 mt-4">
                                <button id="downloadQuoteBtn" class="btn btn-success mt-3">ä¸‹è¼‰å ±åƒ¹å–®</button>
                                </button>
                                <button id="saveRecordBtn" class="btn btn-outline-primary">
                                    <i class="fas fa-save me-2"></i>å„²å­˜è¨˜éŒ„
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ­·å²è¨˜éŒ„ -->
                <div class="card" id="history-section" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>æ­·å²å ±åƒ¹è¨˜éŒ„</span>
                        <div class="input-group" style="max-width: 300px;">
                            <input type="text" class="form-control" id="historySearch" placeholder="æœå°‹å•†å“ç·¨è™Ÿæˆ–åç¨±">
                            <button class="btn btn-outline-secondary" type="button" id="searchHistoryBtn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="historyList" class="row g-3">
                            <!-- å¡ç‰‡å°‡ç”± JS å‹•æ…‹æ’å…¥ -->
                            <p class="text-muted text-center">æ²’æœ‰æ­·å²è¨˜éŒ„</p>
                        </div>
                        <div class="text-center clear-history mt-4">
                            <button id="clearAllHistoryBtn" class="btn btn-outline-danger">
                                <i class="fas fa-trash-alt me-2"></i>æ¸…é™¤æ‰€æœ‰è¨˜éŒ„
                          </button>
                        </div>
                      </div>
                    </div>
            </div>
        </div>
    </div>

  <a href="home.html" class="return-home-btn">ğŸ  è¿”å›ä¸»é </a>
<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    deleteDoc,
    doc,
    getDoc,
    query,
    where,
    orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
  import html2canvas from "https://cdn.skypack.dev/html2canvas";

  const firebaseConfig = {
  apiKey: "AIzaSyCT0Li1XXZ4hZjBTrU8rp1N-ixV5dTrSZQ",
  authDomain: "dg11-c954c.firebaseapp.com",
  projectId: "dg11-c954c",
  storageBucket: "dg11-c954c.firebasestorage.app",
  messagingSenderId: "1010585577335",
  appId: "1:1010585577335:web:ad4f84c5205ba048b22372"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);
  const quotesCollection = collection(db, "quotations");
  let selectedImageFile = null;

  document.addEventListener("DOMContentLoaded", () => {
    const productImageInput = document.getElementById('productImage');
    const imagePreview = document.getElementById('imagePreview');
    const resultImagePreview = document.getElementById('resultImagePreview');

    productImageInput.addEventListener('change', function (e) {
      selectedImageFile = e.target.files[0];
      if (selectedImageFile) {
        const reader = new FileReader();
        reader.onload = function (event) {
          imagePreview.src = event.target.result;
          imagePreview.style.display = 'block';
          resultImagePreview.src = event.target.result;
          resultImagePreview.style.display = 'block';
        };
        reader.readAsDataURL(selectedImageFile);
      }
    });

    const quotationForm = document.getElementById('quotationForm');
    const resultContainer = document.getElementById('resultContainer');
    const saveRecordBtn = document.getElementById('saveRecordBtn');

    quotationForm.addEventListener('submit', function (e) {
      e.preventDefault();
      calculateQuotation();
    });

    async function calculateQuotation(overrideData = null) {
      const productId = document.getElementById('productId').value;
      const productName = document.getElementById('productName').value;
      const productCategory = document.getElementById('productCategory').value;
      const productCost = parseFloat(document.getElementById('productCost').value);
      const costCurrency = document.getElementById('costCurrency').value;
      let productWeight = parseFloat(document.getElementById('productWeight').value);
      const weightUnit = document.getElementById('weightUnit').value;
      const internationalShipping = parseFloat(document.getElementById('internationalShipping').value);
      const serviceFeePercent = parseFloat(document.getElementById('serviceFeePercent').value);
      const additionalServiceFee = parseFloat(document.getElementById('additionalServiceFee').value) || 0;
      const exchangeRate = parseFloat(document.getElementById('exchangeRate').value);

      if (weightUnit === 'kg') {
        productWeight *= 1000;
      }

      const costWithPercent = productCost * (1 + serviceFeePercent);
      const convertedCost = costWithPercent / exchangeRate;
      const shippingFee = productWeight * internationalShipping;
      const totalBeforeService = convertedCost + shippingFee;
      const totalPrice = totalBeforeService + additionalServiceFee;

      const now = new Date();

      document.getElementById('resultProductId').textContent = productId;
      document.getElementById('resultProductName').textContent = productName;
      document.getElementById('resultProductCategory').textContent = productCategory;
      document.getElementById('resultProductCost').textContent = `${productCost.toFixed(2)} ${costCurrency}`;
      document.getElementById('resultProductWeight').textContent = `${productWeight.toFixed(2)}g`;
      document.getElementById('resultShippingFee').textContent = `NT$ ${shippingFee.toFixed(2)}`;
      document.getElementById('resultTotalPrice').textContent = `NT$ ${totalPrice.toFixed(2)}`;
      document.getElementById('calculationTime').textContent = now.toLocaleString();

      if (overrideData?.imageUrl) {
        resultImagePreview.src = overrideData.imageUrl;
        resultImagePreview.style.display = 'block';
      }

      resultContainer.style.display = 'block';

      saveRecordBtn.onclick = () => {
        saveQuotationToFirestore({
          productId,
          productName,
          productCategory,
          productCost,
          costCurrency,
          productWeight,
          internationalShipping,
          serviceFeePercent,
          additionalServiceFee,
          exchangeRate,
          totalPrice,
          timestamp: now.getTime(),
          dateString: now.toLocaleString()
        });
      };
    }

    async function saveQuotationToFirestore(quotation) {
      try {
        let imageUrl = '';
        if (selectedImageFile) {
          const storageRef = ref(storage, `quotation_images/${Date.now()}_${selectedImageFile.name}`);
          const snapshot = await uploadBytes(storageRef, selectedImageFile);
          imageUrl = await getDownloadURL(snapshot.ref);
        }

        const fullData = { ...quotation, imageUrl };
        await addDoc(quotesCollection, fullData);
        alert("å ±åƒ¹å·²æˆåŠŸä¿å­˜åˆ°é›²ç«¯ï¼");
        loadHistory();
      } catch (error) {
        console.error("ä¿å­˜å ±åƒ¹æ™‚å‡ºéŒ¯:", error);
        alert("ä¿å­˜å¤±æ•—: " + error.message);
      }
    }

    async function loadHistory(searchTerm = '') {
      try {
        let q;
        if (searchTerm) {
          q = query(
            quotesCollection,
            where("productId", ">=", searchTerm),
            where("productId", "<=", searchTerm + '\uf8ff'),
            orderBy("timestamp", "desc")
          );
        } else {
          q = query(quotesCollection, orderBy("timestamp", "desc"));
        }

        const snapshot = await getDocs(q);
        const historyList = document.getElementById('historyList');
        historyList.innerHTML = '';

        if (snapshot.empty) {
          historyList.innerHTML = '<p class="text-muted text-center">æ²’æœ‰æ­·å²è¨˜éŒ„</p>';
          return;
        }

        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const historyItem = document.createElement('div');
          historyItem.className = 'col-md-6';
          historyItem.innerHTML = `
            <div class="history-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6>${data.productName || 'æœªå‘½åå•†å“'}</h6>
                  <p class="mb-1"><small class="text-muted">ç·¨è™Ÿ: ${data.productId || 'ç„¡'}</small></p>
                </div>
                <div>
                  <button class="btn btn-sm btn-primary view-history" data-id="${docSnap.id}">æŸ¥çœ‹</button>
                  <button class="btn btn-sm btn-outline-danger delete-history" data-id="${docSnap.id}">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
              </div>
              <div class="mt-2">
                <p class="mb-1"><strong>é¡åˆ¥:</strong> ${data.productCategory || 'æœªåˆ†é¡'}</p>
                <p class="mb-1"><strong>æˆæœ¬:</strong> ${data.productCost?.toFixed(2) || '0.00'} ${data.costCurrency || ''}</p>
                <p class="mb-1"><strong>é‡é‡:</strong> ${data.productWeight?.toFixed(2) || '0.00'}g</p>
                <p class="mb-1"><strong>ç¸½åƒ¹:</strong> NT$ ${data.totalPrice?.toFixed(2) || '0.00'}</p>
                <p class="mb-0"><small class="text-muted">${data.dateString || ''}</small></p>
              </div>
              ${data.imageUrl ? `<img src="${data.imageUrl}" class="img-thumbnail mt-2" style="max-height: 100px;">` : ''}
            </div>
          `;
          historyList.appendChild(historyItem);
        });

        document.querySelectorAll('.delete-history').forEach(button => {
          button.addEventListener('click', async function () {
            const id = this.getAttribute('data-id');
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨˜éŒ„å—ï¼Ÿ')) {
              try {
                await deleteDoc(doc(db, "quotations", id));
                loadHistory(searchTerm);
              } catch (error) {
                console.error("åˆªé™¤è¨˜éŒ„æ™‚å‡ºéŒ¯:", error);
                alert("åˆªé™¤å¤±æ•—: " + error.message);
              }
            }
          });
        });

        document.querySelectorAll('.view-history').forEach(button => {
          button.addEventListener('click', async function () {
            const id = this.getAttribute('data-id');
            const docRef = doc(db, "quotations", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
              const data = docSnap.data();
              document.getElementById('productId').value = data.productId || '';
              document.getElementById('productName').value = data.productName || '';
              document.getElementById('productCategory').value = data.productCategory || '';
              document.getElementById('productCost').value = data.productCost || '';
              document.getElementById('costCurrency').value = data.costCurrency || '';
              document.getElementById('productWeight').value = data.productWeight || '';
              document.getElementById('weightUnit').value = 'g';
              document.getElementById('internationalShipping').value = data.internationalShipping || '';
              document.getElementById('serviceFeePercent').value = data.serviceFeePercent || '';
              document.getElementById('additionalServiceFee').value = data.additionalServiceFee || '';
              document.getElementById('exchangeRate').value = data.exchangeRate || '';

              if (data.imageUrl) {
                resultImagePreview.src = data.imageUrl;
                resultImagePreview.style.display = 'block';
              }

              document.getElementById('quotation-tab').click();
              calculateQuotation(data);
            }
          });
        });

      } catch (error) {
        console.error("åŠ è¼‰æ­·å²è¨˜éŒ„æ™‚å‡ºéŒ¯:", error);
        document.getElementById('historyList').innerHTML = '<p class="text-danger text-center">åŠ è¼‰æ­·å²è¨˜éŒ„å¤±æ•—</p>';
      }
    }

    // æ–°å¢æ¸…é™¤æ‰€æœ‰æ­·å²è¨˜éŒ„åŠŸèƒ½
    async function clearAllHistory() {
      if (confirm('ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æ­·å²è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
        try {
          const snapshot = await getDocs(quotesCollection);
          const deletePromises = [];
          snapshot.forEach(docSnap => {
            deletePromises.push(deleteDoc(doc(db, "quotations", docSnap.id)));
          });
          await Promise.all(deletePromises);
          alert('æ‰€æœ‰æ­·å²è¨˜éŒ„å·²æˆåŠŸåˆªé™¤ï¼');
          loadHistory();
        } catch (error) {
          console.error("åˆªé™¤æ‰€æœ‰è¨˜éŒ„æ™‚å‡ºéŒ¯:", error);
          alert("åˆªé™¤å¤±æ•—: " + error.message);
        }
      }
    }

    // ç¶å®šæ¸…é™¤æ‰€æœ‰æ­·å²è¨˜éŒ„æŒ‰éˆ•äº‹ä»¶
    document.getElementById('clearAllHistoryBtn')?.addEventListener('click', clearAllHistory);

    document.getElementById('historySearch')?.addEventListener('input', function () {
      loadHistory(this.value.trim());
    });

    document.getElementById('searchHistoryBtn')?.addEventListener('click', function () {
      const searchInput = document.getElementById('historySearch');
      loadHistory(searchInput.value.trim());
    });

    document.getElementById('quotation-tab')?.addEventListener('click', function () {
      document.getElementById('quotation-section').style.display = 'block';
      document.getElementById('history-section').style.display = 'none';
      this.classList.add('active');
      document.getElementById('history-tab').classList.remove('active');
    });

    document.getElementById('history-tab')?.addEventListener('click', function () {
      document.getElementById('quotation-section').style.display = 'none';
      document.getElementById('history-section').style.display = 'block';
      this.classList.add('active');
      document.getElementById('quotation-tab').classList.remove('active');
      loadHistory();
    });

    document.getElementById('downloadQuoteBtn')?.addEventListener('click', async () => {
      const resultContainer = document.getElementById('resultContainer');
      if (!resultContainer) return;
      try {
        const canvas = await html2canvas(resultContainer);
        const link = document.createElement("a");
        link.download = "quotation.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      } catch (err) {
        console.error("ç”Ÿæˆåœ–ç‰‡å¤±æ•—:", err);
        alert("ä¸‹è¼‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      }
    });

    loadHistory();
  });
</script>
<div class="hamburger" onclick="toggleMenu()">â˜°</div>

<!-- å´é‚Šé¸å–® -->
<nav class="side-menu" id="sideMenu">
  <a href="orders.html">è¨‚å–®ç®¡ç†</a>
  <a href="products.html">åº«å­˜ç®¡ç†</a>
  <a href="shipment.html">å‡ºè²¨ç®¡ç†</a>
  <a href="report.html">å ±è¡¨åˆ†æ</a>
    <a href="order_registration.html">é™æ™‚é€£ç·š</a>
  <a href="link-management.html">ç¶²å€é€£çµç®¡ç†</a>
  <a href="blacklist.html">é»‘åå–®</a>
</nav>
<style>
    .hamburger {
  font-size: 2rem;
  position: fixed;
  top: 20px;
  left: 20px;
  cursor: pointer;
  z-index: 1001;
  background: linear-gradient(to right, #ff80ab, #ffb6c1);
  color: white;
  padding: 10px 20px;
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(255, 105, 180, 0.4);
}

.side-menu {
  position: fixed;
  top: 0;
  left: -250px;
  width: 220px;
  height: 100%;
  background: rgba(255, 192, 203, 0.95);
  backdrop-filter: blur(20px);
  box-shadow: 5px 0 20px rgba(255, 105, 180, 0.3);
  display: flex;
  flex-direction: column;
  padding-top: 80px;
  transition: left 0.3s ease;
  z-index: 1000;
}

.side-menu a {
  padding: 20px;
  color: white;
  text-decoration: none;
  font-weight: bold;
  font-size: 1.1rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  transition: background 0.3s;
}

.side-menu a:hover {
  background: rgba(255, 105, 180, 0.2);
}

</style>
<script>
    function toggleMenu() {
      const menu = document.getElementById("sideMenu");
      if (menu.style.left === "0px") {
        menu.style.left = "-250px";
      } else {
        menu.style.left = "0px";
      }
    }
  </script>
  
</body>
</html>
